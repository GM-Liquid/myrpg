name: Build & Publish Latest Release

on:
  push:
    branches: [ "main" ]

# ⬅️  даём токену права писать релизы / ассеты
permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Клонируем репозиторий
      - name: Checkout
        uses: actions/checkout@v4

      # 2️⃣ Готовим «чистую» папку dist
      - name: Prepare distribution folder
        run: |
          rm -rf dist
          mkdir dist
          # каталоги системы
          cp -R module templates css lang assets dist/ 2>/dev/null || true
          # обязательные файлы
          cp system.json template.json README.md LICENSE dist/ 2>/dev/null || true

      # 3️⃣ Упаковываем dist в myrpg.zip
      - name: Zip distribution
        run: |
          cd dist
          zip -r ../myrpg.zip .

      # 4️⃣ Публикуем или обновляем релиз с тегом latest
      - name: Publish or update GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest           # всегда один тег
          name: Latest build (auto)
          body: |
            ⚠️ Автоматическая сборка с ветки **main**.
            * `myrpg.zip` — полный пакет системы;
            * `system.json` — манифест отдельно.
          files: |
            myrpg.zip
            system.json               # ← отдельным ассетом
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 5️⃣ Прибираемся
      - name: Clean up
        run: rm -rf dist myrpg.zip